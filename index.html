<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Funil de Vendas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f9fafb 0%, #f0fdf4 50%, #ecfdf5 100%);
            min-height: 100vh;
            color: #374151;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 30px;
            font-weight: bold;
            background: linear-gradient(to right, #0a4d3a, #1a5f4a);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }

        .subtitle {
            font-size: 18px;
            color: #6b7280;
            font-weight: 500;
        }

        .divider {
            margin: 12px auto 0;
            width: 96px;
            height: 2px;
            background: linear-gradient(to right, #1a5f4a, #66ffaa);
            border-radius: 2px;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        /* Debug Info */
        .debug-card {
            position: relative;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid #66ffaa;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 32px;
        }

        .debug-title {
            font-size: 14px;
            font-weight: bold;
            color: #0a4d3a;
            margin-bottom: 12px;
        }

        .debug-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .debug-item {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .debug-label {
            font-size: 12px;
            font-weight: 500;
            color: #1a5f4a;
        }

        .debug-value {
            font-size: 14px;
            font-weight: bold;
            color: #0a4d3a;
        }

        .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #fee2e2;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .close-btn:hover {
            background: #fecaca;
        }

        /* Filters */
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .filters-title-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-container {
            background: linear-gradient(135deg, #1a5f4a 0%, #0a4d3a 100%);
            padding: 10px;
            border-radius: 12px;
        }

        .icon {
            width: 20px;
            height: 20px;
            stroke: white;
            fill: none;
            stroke-width: 2;
        }

        .filters-title {
            font-size: 20px;
            font-weight: bold;
            color: #374151;
        }

        .clear-btn {
            background: linear-gradient(to right, #1a5f4a, #0a4d3a);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .clear-btn:hover {
            transform: scale(1.05);
            background: linear-gradient(to right, #0a4d3a, #065f46);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .filter-input, .filter-select {
            padding: 12px;
            background: white;
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            font-size: 14px;
            color: #374151;
            transition: border-color 0.3s;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #1a5f4a;
        }

        /* Highlight filtros ativos */
        .filter-active {
            border-color: #1a5f4a !important;
            background: #f0fdf4 !important;
            box-shadow: 0 0 0 2px rgba(26, 95, 74, 0.1);
        }

        /* Funnel */
        .funnel-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(to right, #0a4d3a, #1a5f4a);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 32px;
        }

        /* Funil com formato real */
        .funnel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
        }

        .funnel-item {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .funnel-step {
            position: relative;
            text-align: center;
            transition: all 0.5s ease;
            cursor: pointer;
            margin: 4px 0;
        }

        .funnel-step:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
        }

        /* Estilos espec√≠ficos para cada etapa do funil */
        .funnel-step-0 { /* Leads */
            width: 100%;
            max-width: 600px;
            background: linear-gradient(135deg, #0a4d3a 0%, #065f46 100%);
            clip-path: polygon(0% 0%, 100% 0%, 95% 100%, 5% 100%);
            padding: 20px 40px;
        }

        .funnel-step-1 { /* Oportunidades */
            width: 85%;
            max-width: 510px;
            background: linear-gradient(135deg, #1a5f4a 0%, #047857 100%);
            clip-path: polygon(0% 0%, 100% 0%, 94% 100%, 6% 100%);
            padding: 18px 35px;
        }

        .funnel-step-2 { /* Agendamentos */
            width: 70%;
            max-width: 420px;
            background: linear-gradient(135deg, #0a4d3a 0%, #065f46 100%);
            clip-path: polygon(0% 0%, 100% 0%, 92% 100%, 8% 100%);
            padding: 16px 30px;
        }

        .funnel-step-3 { /* Visitas */
            width: 55%;
            max-width: 330px;
            background: linear-gradient(135deg, #1a5f4a 0%, #047857 100%);
            clip-path: polygon(0% 0%, 100% 0%, 90% 100%, 10% 100%);
            padding: 14px 25px;
        }

        .funnel-step-4 { /* Pasta Total */
            width: 45%;
            max-width: 270px;
            background: linear-gradient(135deg, #0a4d3a 0%, #065f46 100%);
            clip-path: polygon(0% 0%, 100% 0%, 88% 100%, 12% 100%);
            padding: 12px 20px;
        }

        .funnel-step-5 { /* Pasta Analisada */
            width: 35%;
            max-width: 210px;
            background: linear-gradient(135deg, #1a5f4a 0%, #047857 100%);
            clip-path: polygon(0% 0%, 100% 0%, 85% 100%, 15% 100%);
            padding: 10px 15px;
        }

        .funnel-step-6 { /* Vendas */
            width: 25%;
            max-width: 150px;
            background: linear-gradient(135deg, #66ffaa 0%, #4ade80 100%);
            clip-path: polygon(0% 0%, 100% 0%, 80% 100%, 20% 100%);
            padding: 12px 15px;
            border: 2px solid #22c55e;
            box-shadow: 0 8px 25px rgba(102, 255, 170, 0.3);
        }

        .funnel-content {
            position: relative;
            z-index: 2;
            color: white;
        }

        .funnel-step-6 .funnel-content {
            color: #1f2937;
        }

        .funnel-header-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .funnel-icon {
            width: 20px;
            height: 20px;
            stroke: white;
            fill: none;
            stroke-width: 2;
        }

        .funnel-step-6 .funnel-icon {
            stroke: #1f2937;
        }

        .funnel-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .funnel-value {
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .funnel-step-6 .funnel-value {
            text-shadow: none;
        }

        /* Conectores do funil */
        .funnel-connector {
            width: 2px;
            height: 12px;
            background: linear-gradient(to bottom, #1a5f4a, #0a4d3a);
            margin: 0 auto;
            opacity: 0.6;
        }

        /* Ajustes responsivos para o funil */
        @media (max-width: 768px) {
            .funnel-step {
                margin: 2px 0;
            }
            
            .funnel-step-0 { padding: 16px 30px; }
            .funnel-step-1 { padding: 14px 25px; }
            .funnel-step-2 { padding: 12px 20px; }
            .funnel-step-3 { padding: 10px 18px; }
            .funnel-step-4 { padding: 8px 15px; }
            .funnel-step-5 { padding: 6px 12px; }
            .funnel-step-6 { padding: 8px 12px; }
            
            .funnel-label {
                font-size: 14px;
            }
            
            .funnel-value {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .funnel-step-0 { width: 100%; max-width: 300px; }
            .funnel-step-1 { width: 90%; max-width: 270px; }
            .funnel-step-2 { width: 80%; max-width: 240px; }
            .funnel-step-3 { width: 70%; max-width: 210px; }
            .funnel-step-4 { width: 60%; max-width: 180px; }
            .funnel-step-5 { width: 50%; max-width: 150px; }
            .funnel-step-6 { width: 40%; max-width: 120px; }
        }

        /* Conversion Rates */
        .conversion-section {
            margin-top: 48px;
            padding-top: 24px;
            border-top: 1px solid rgba(34, 197, 94, 0.3);
        }

        .conversion-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            color: #0a4d3a;
            margin-bottom: 24px;
        }

        .conversion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .conversion-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(34, 197, 94, 0.2);
            text-align: center;
            transition: box-shadow 0.3s;
        }

        .conversion-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .conversion-label {
            font-size: 12px;
            font-weight: 500;
            color: #1a5f4a;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .conversion-rate {
            font-size: 18px;
            font-weight: bold;
            color: #0a4d3a;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            flex-direction: column;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #0a4d3a;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: #0a4d3a;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes highlight {
            0% { background-color: rgba(102, 255, 170, 0.3); }
            100% { background-color: transparent; }
        }

        /* Anima√ß√£o para valores que mudaram */
        .value-changed {
            animation: highlight 1s ease-out;
        }

        .funnel-step.updated {
            animation: pulse 0.5s ease-out;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .title {
                font-size: 24px;
            }
            
            .filters-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .conversion-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Utility classes */
        .hidden {
            display: none;
        }

        /* Filter status indicator */
        .filter-status {
            margin-top: 16px;
            padding: 12px;
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            font-size: 13px;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">
            <div class="spinner"></div>
            <div class="loading-text">Carregando dados...</div>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let state = {
            leads: [],
            visitas: [],
            pastas: [],
            vendas: [],
            loading: true,
            showDebug: true,
            filters: {
                empreendimento: '',
                origemMidia: '',
                dataInicio: '',
                dataFim: '',
                imobiliaria: '',
                corretor: '',
                tipoVisita: '',
                tipoMidia: '',
                qualificacao: '',
                situacaoVisita: ''
            }
        };

        // Utilit√°rios melhorados
        function cleanString(str) {
            if (!str) return '';
            return str.toString().trim().toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^\w\s]/g, ''); // Remove caracteres especiais
        }

        // Fun√ß√£o auxiliar para extrair origem m√≠dia de um item
        function getOrigemMidia(item) {
            // Nomes reais nos seus CSVs com codifica√ß√£o cp1252
            return item['Origem M dia'] || item['Origem M√≠dia'] || item['ORIGEM M√çDEA'] || '';
        }

        // Fun√ß√£o auxiliar para extrair tipo m√≠dia de um item
        function getTipoMidia(item) {
            // Nomes reais nos seus CSVs com codifica√ß√£o cp1252
            return item['Tipo de M dia'] || item['Tipo de M√≠dia'] || item['TIPO DE M√çDIA'] || '';
        }

        // Fun√ß√£o auxiliar para extrair tipo visita de um item
        function getTipoVisita(item) {
            return item['Tipo da visita'] || '';
        }

        // Fun√ß√£o auxiliar para extrair imobili√°ria de um item
        function getImobiliaria(item) {
            return item['Imobili ria'] || item['Imobili√°ria'] || '';
        }

        // Fun√ß√£o auxiliar para extrair situa√ß√£o da visita
        function getSituacaoVisita(item) {
            // Nomes reais nos seus CSVs com codifica√ß√£o cp1252
            return item['Situa  o da visita'] || item['Situa√ß√£o da visita'] || '';
        }

        function isDateInRange(dateStr, startDate, endDate) {
            if (!dateStr || (!startDate && !endDate)) return true;
            
            try {
                const date = new Date(dateStr.split('/').reverse().join('-'));
                const start = startDate ? new Date(startDate) : null;
                const end = endDate ? new Date(endDate) : null;
                
                if (start && date < start) return false;
                if (end && date > end) return false;
                return true;
            } catch {
                return true;
            }
        }

        // Fun√ß√£o de filtros corrigida para usar os nomes exatos das colunas
        function applyFilters(data, dateField = 'Data') {
            const filteredData = data.filter(item => {
                // Filtro por empreendimento
                if (state.filters.empreendimento) {
                    const empreendimento = cleanString(item.Empreendimento || '');
                    if (!empreendimento.includes(cleanString(state.filters.empreendimento))) {
                        return false;
                    }
                }
                
                // Filtro por origem m√≠dia - usando nome correto com codifica√ß√£o
                if (state.filters.origemMidia) {
                    const origem = cleanString(getOrigemMidia(item));
                    if (!origem.includes(cleanString(state.filters.origemMidia))) {
                        return false;
                    }
                }
                
                // Filtro por tipo m√≠dia - usando nome correto com codifica√ß√£o
                if (state.filters.tipoMidia) {
                    const tipo = cleanString(getTipoMidia(item));
                    if (!tipo.includes(cleanString(state.filters.tipoMidia))) {
                        return false;
                    }
                }
                
                // Filtro por tipo visita
                if (state.filters.tipoVisita) {
                    const tipoVisita = cleanString(getTipoVisita(item));
                    if (!tipoVisita.includes(cleanString(state.filters.tipoVisita))) {
                        return false;
                    }
                }
                
                // Filtro por imobili√°ria - usando nome correto com codifica√ß√£o
                if (state.filters.imobiliaria) {
                    const imob = cleanString(getImobiliaria(item));
                    if (!imob.includes(cleanString(state.filters.imobiliaria))) {
                        return false;
                    }
                }
                
                // Filtro por corretor
                if (state.filters.corretor) {
                    const corretor = cleanString(item.Corretor || '');
                    if (!corretor.includes(cleanString(state.filters.corretor))) {
                        return false;
                    }
                }
                
                // Filtro por qualifica√ß√£o
                if (state.filters.qualificacao) {
                    const qualificacao = cleanString(item.QUALIFICADO || '');
                    if (!qualificacao.includes(cleanString(state.filters.qualificacao))) {
                        return false;
                    }
                }
                
                // Filtro por situa√ß√£o da visita
                if (state.filters.situacaoVisita) {
                    const situacao = cleanString(getSituacaoVisita(item));
                    if (!situacao.includes(cleanString(state.filters.situacaoVisita))) {
                        return false;
                    }
                }
                
                // Filtro por data
                const dataItem = item[dateField] || item['Data do Cadastro'] || item['Data'];
                if (!isDateInRange(dataItem, state.filters.dataInicio, state.filters.dataFim)) {
                    return false;
                }
                
                return true;
            });

            console.log(`Filtros aplicados: ${data.length} ‚Üí ${filteredData.length} registros`, {
                original: data.length,
                filtered: filteredData.length,
                filters: Object.entries(state.filters).filter(([key, value]) => value).map(([key, value]) => `${key}: ${value}`)
            });

            return filteredData;
        }

        function calculateFunilDataWithoutFilters() {
            if (state.loading) {
                return { totalLeads: 0, oportunidades: 0, agendamentos: 0, visitasConcluidas: 0, totalPastas: 0, pastasAnalisadas: 0, totalVendas: 0 };
            }

            try {
                // Usar dados SEM filtros para compara√ß√£o
                const leads = state.leads;
                const visitas = state.visitas;
                const pastas = state.pastas;
                const vendas = state.vendas;

                const totalLeads = leads.reduce((sum, item) => sum + (parseInt(item.LEADS) || 0), 0);
                
                const oportunidades = leads.filter(item => {
                    const qualificado = cleanString(item.QUALIFICADO || '');
                    return qualificado === 'qualificado' || qualificado === 'nao qualificado';
                }).reduce((sum, item) => sum + (parseInt(item.LEADS) || 0), 0);

                const agendamentos = visitas.filter(item => {
                    const tipoVisita = cleanString(getTipoVisita(item));
                    return tipoVisita === 'visita agendada' || tipoVisita === 'agendamento ga';
                }).reduce((sum, item) => sum + (parseInt(item.VISITA) || 0), 0);

                const visitasConcluidas = visitas.filter(item => {
                    const situacao = getSituacaoVisita(item);
                    return situacao === 'Conclu do' || situacao === 'Conclu√≠do' || cleanString(situacao) === 'concludo';
                }).reduce((sum, item) => sum + (parseInt(item.VISITA) || 0), 0);

                const totalPastas = pastas.reduce((sum, item) => sum + (parseInt(item.PASTA) || 0), 0);

                const pastasAnalisadas = pastas.filter(item => {
                    const pastaAnalisada = cleanString(item['Pasta analisada'] || '');
                    const valorPrestacao = item[' Valor Presta  o '] || item['Valor Presta  o'] || item[' Valor Presta√ß√£o '] || '';
                    
                    if (pastaAnalisada !== '' && pastaAnalisada !== '0' && pastaAnalisada !== 'nao' && pastaAnalisada !== 'n o') {
                        return true;
                    }
                    
                    if (valorPrestacao && valorPrestacao.toString().trim() !== '') {
                        try {
                            const valorLimpo = valorPrestacao.toString().trim().replace(/\./g, '').replace(',', '.');
                            const valor = parseFloat(valorLimpo.replace(/[^\d.-]/g, ''));
                            return !isNaN(valor) && valor > 0;
                        } catch {
                            return false;
                        }
                    }
                    
                    return false;
                }).reduce((sum, item) => sum + (parseInt(item.PASTA) || 0), 0);

                const totalVendas = vendas.reduce((sum, item) => sum + (parseInt(item.VENDA) || 0), 0);

                return {
                    totalLeads,
                    oportunidades,
                    agendamentos,
                    visitasConcluidas,
                    totalPastas,
                    pastasAnalisadas,
                    totalVendas
                };

            } catch (error) {
                console.error('Erro nos c√°lculos sem filtros:', error);
                return { totalLeads: 0, oportunidades: 0, agendamentos: 0, visitasConcluidas: 0, totalPastas: 0, pastasAnalisadas: 0, totalVendas: 0 };
            }
        }

        function calculateFunilData() {
            if (state.loading) {
                return { totalLeads: 0, oportunidades: 0, agendamentos: 0, visitasConcluidas: 0, totalPastas: 0, pastasAnalisadas: 0, totalVendas: 0 };
            }

            try {
                // Aplicar filtros para cada fonte de dados (usar 'Data' para todos exceto pastas)
                const filteredLeads = applyFilters(state.leads, 'Data');
                const filteredVisitas = applyFilters(state.visitas, 'Data');
                const filteredPastas = applyFilters(state.pastas, 'Data'); // PASTA.csv tamb√©m usa 'Data'
                const filteredVendas = applyFilters(state.vendas, 'Data');

                console.log('Dados filtrados:', {
                    leads: filteredLeads.length,
                    visitas: filteredVisitas.length,
                    pastas: filteredPastas.length,
                    vendas: filteredVendas.length
                });

                // Debug detalhado para visitas conclu√≠das com filtros aplicados
                const visitasComSituacao = filteredVisitas.filter(item => getSituacaoVisita(item).trim() !== '');
                const situacoesUnicas = [...new Set(filteredVisitas.map(item => getSituacaoVisita(item)).filter(s => s.trim() !== ''))];
                
                // Contar visitas conclu√≠das ap√≥s filtros
                const visitasConcluidasDetalhado = filteredVisitas.filter(item => {
                    const situacao = getSituacaoVisita(item);
                    return situacao === 'Conclu do' || situacao === 'Conclu√≠do' || cleanString(situacao) === 'concludo';
                });
                
                console.log('üîç Debug Visitas Conclu√≠das (com filtros aplicados):', {
                    totalVisitasOriginais: state.visitas.length,
                    visitasFiltradas: filteredVisitas.length,
                    visitasComSituacao: visitasComSituacao.length,
                    situacoesEncontradas: situacoesUnicas,
                    visitasConcluidasCount: visitasConcluidasDetalhado.length,
                    visitasConcluidasTotal: visitasConcluidasDetalhado.reduce((sum, item) => sum + (parseInt(item.VISITA) || 0), 0),
                    filtrosAtivos: Object.entries(state.filters).filter(([k, v]) => v).length,
                    percentualConclusao: filteredVisitas.length > 0 ? ((visitasConcluidasDetalhado.reduce((sum, item) => sum + (parseInt(item.VISITA) || 0), 0) / filteredVisitas.length) * 100).toFixed(1) + '%' : '0%'
                });

                // Total de leads
                const totalLeads = filteredLeads.reduce((sum, item) => sum + (parseInt(item.LEADS) || 0), 0);
                
                // Oportunidades (leads qualificados ou n√£o qualificados) - baseado nos dados reais
                const oportunidades = filteredLeads.filter(item => {
                    const qualificado = cleanString(item.QUALIFICADO || '');
                    return qualificado === 'qualificado' || qualificado === 'nao qualificado';
                }).reduce((sum, item) => sum + (parseInt(item.LEADS) || 0), 0);

                // Agendamentos (visitas agendadas) - baseado nos dados reais 
                const agendamentos = filteredVisitas.filter(item => {
                    const tipoVisita = cleanString(item['Tipo da visita'] || '');
                    return tipoVisita === 'visita agendada' || tipoVisita === 'agendamento ga';
                }).reduce((sum, item) => sum + (parseInt(item.VISITA) || 0), 0);

                // Visitas conclu√≠das - usando valor exato encontrado nos dados reais
                const visitasConcluidas = filteredVisitas.filter(item => {
                    const situacao = getSituacaoVisita(item);
                    // Verificar o valor exato encontrado nos dados: "Conclu do"
                    return situacao === 'Conclu do' || situacao === 'Conclu√≠do' || cleanString(situacao) === 'concludo';
                }).reduce((sum, item) => sum + (parseInt(item.VISITA) || 0), 0);

                // Total de pastas
                const totalPastas = filteredPastas.reduce((sum, item) => sum + (parseInt(item.PASTA) || 0), 0);

                // Pastas analisadas - baseado na coluna 'Pasta analisada' dos dados reais
                const pastasAnalisadas = filteredPastas.filter(item => {
                    // Verificar se tem valor na coluna 'Pasta analisada' ou se tem 'Valor Presta√ß√£o'
                    const pastaAnalisada = cleanString(item['Pasta analisada'] || '');
                    const valorPrestacao = item[' Valor Presta  o '] || item['Valor Presta  o'] || item[' Valor Presta√ß√£o '] || '';
                    
                    if (valorPrestacao && valorPrestacao.toString().trim() !== '') {
                        try {
                            const valorLimpo = valorPrestacao.toString().trim().replace(/\./g, '').replace(',', '.');
                            const valor = parseFloat(valorLimpo.replace(/[^\d.-]/g, ''));
                            return !isNaN(valor) && valor > 0;
                        } catch {
                            return false;
                        }
                    }
                }).reduce((sum, item) => sum + (parseInt(item.PASTA) || 0), 0);

                // Total de vendas
                const totalVendas = filteredVendas.reduce((sum, item) => sum + (parseInt(item.VENDA) || 0), 0);

                const result = {
                    totalLeads,
                    oportunidades,
                    agendamentos,
                    visitasConcluidas,
                    totalPastas,
                    pastasAnalisadas,
                    totalVendas
                };

                console.log('Resultado do funil:', result);
                return result;

            } catch (error) {
                console.error('Erro nos c√°lculos:', error);
                return { totalLeads: 0, oportunidades: 0, agendamentos: 0, visitasConcluidas: 0, totalPastas: 0, pastasAnalisadas: 0, totalVendas: 0 };
            }
        }

        function getFilterOptions() {
            if (state.loading) {
                return { empreendimentos: [], origemMidia: [], imobiliarias: [], corretores: [], tiposVisita: [], tiposMidia: [], qualificacoes: [], situacoesVisita: [] };
            }

            try {
                const allData = [...state.leads, ...state.visitas, ...state.pastas, ...state.vendas];
                
                // Extrair valores √∫nicos usando as fun√ß√µes auxiliares que lidam com a codifica√ß√£o
                const empreendimentos = [...new Set(allData.map(item => item.Empreendimento).filter(val => val && val.trim() !== ''))].sort();
                
                // Origem M√≠dia - usando fun√ß√£o auxiliar
                const origemMidia = [...new Set(allData.map(item => getOrigemMidia(item)).filter(val => val && val.trim() !== ''))].sort();
                
                // Imobili√°ria - usando fun√ß√£o auxiliar  
                const imobiliarias = [...new Set(allData.map(item => getImobiliaria(item)).filter(val => val && val.trim() !== ''))].sort();
                
                const corretores = [...new Set(allData.map(item => item.Corretor).filter(val => val && val.trim() !== ''))].sort();
                
                // Tipos de visita - apenas de dados de VISITA
                const tiposVisita = [...new Set(state.visitas.map(item => getTipoVisita(item)).filter(val => val && val.trim() !== ''))].sort();
                
                // Tipo de M√≠dia - usando fun√ß√£o auxiliar
                const tiposMidia = [...new Set(allData.map(item => getTipoMidia(item)).filter(val => val && val.trim() !== ''))].sort();
                
                // Situa√ß√µes de visita - apenas de dados de VISITA
                const situacoesVisita = [...new Set(state.visitas.map(item => getSituacaoVisita(item)).filter(val => val && val.trim() !== ''))].sort();
                
                const qualificacoes = [...new Set(allData.map(item => item.QUALIFICADO).filter(val => val && val.trim() !== ''))].sort();

                console.log('Valores √∫nicos extra√≠dos:', {
                    empreendimentos: empreendimentos.length,
                    origemMidia: origemMidia.length,
                    imobiliarias: imobiliarias.length,
                    corretores: corretores.length,
                    tiposVisita: tiposVisita.length,
                    tiposMidia: tiposMidia.length,
                    situacoesVisita: situacoesVisita.length,
                    qualificacoes: qualificacoes.length
                });

                // Debug: mostrar primeiros valores encontrados
                console.log('Primeiros valores de Origem M√≠dia:', origemMidia.slice(0, 5));
                console.log('Primeiros valores de Tipo de M√≠dia:', tiposMidia.slice(0, 5));
                console.log('Tipos de visita encontrados:', tiposVisita);
                console.log('Situa√ß√µes de visita encontradas:', situacoesVisita);

                return {
                    empreendimentos,
                    origemMidia,
                    imobiliarias,
                    corretores,
                    tiposVisita,
                    tiposMidia,
                    situacoesVisita,
                    qualificacoes
                };
            } catch (error) {
                console.error('Erro ao extrair op√ß√µes:', error);
                return { empreendimentos: [], origemMidia: [], imobiliarias: [], corretores: [], tiposVisita: [], tiposMidia: [], situacoesVisita: [], qualificacoes: [] };
            }
        }

        // Fun√ß√£o auxiliar para atualizar filtros e renderizar
        function updateFilter(filterName, value) {
            console.log(`üîÑ Filtro alterado: ${filterName} = "${value}"`);
            
            // Guardar valores anteriores para compara√ß√£o
            const oldData = calculateFunilData();
            
            // Aplicar novo filtro
            state.filters[filterName] = value;
            
            // Calcular novos valores
            const newData = calculateFunilData();
            
            // Log detalhado do impacto
            console.log(`üìä Impacto do filtro "${filterName}":`, {
                filtrosAtivos: Object.entries(state.filters).filter(([k, v]) => v).length,
                mudancas: {
                    leads: `${oldData.totalLeads} ‚Üí ${newData.totalLeads}`,
                    oportunidades: `${oldData.oportunidades} ‚Üí ${newData.oportunidades}`,
                    agendamentos: `${oldData.agendamentos} ‚Üí ${newData.agendamentos}`,
                    visitasConcluidas: `${oldData.visitasConcluidas} ‚Üí ${newData.visitasConcluidas}`,
                    pastas: `${oldData.totalPastas} ‚Üí ${newData.totalPastas}`,
                    vendas: `${oldData.totalVendas} ‚Üí ${newData.totalVendas}`
                }
            });
            
            // Destacar se visitas conclu√≠das mudaram significativamente
            if (Math.abs(oldData.visitasConcluidas - newData.visitasConcluidas) > 0) {
                console.log(`üéØ VISITAS CONCLU√çDAS: ${oldData.visitasConcluidas} ‚Üí ${newData.visitasConcluidas} (${newData.visitasConcluidas > oldData.visitasConcluidas ? '+' : ''}${newData.visitasConcluidas - oldData.visitasConcluidas})`);
            }
            
            // Re-renderizar
            render();
        }

        function clearFilters() {
            console.log('üßπ Limpando todos os filtros...');
            
            const oldData = calculateFunilData();
            
            state.filters = {
                empreendimento: '',
                origemMidia: '',
                dataInicio: '',
                dataFim: '',
                imobiliaria: '',
                corretor: '',
                tipoVisita: '',
                tipoMidia: '',
                qualificacao: '',
                situacaoVisita: ''
            };
            
            const newData = calculateFunilData();
            
            console.log('üìä Ap√≥s limpar filtros:', {
                visitasConcluidas: `${oldData.visitasConcluidas} ‚Üí ${newData.visitasConcluidas}`,
                totalLeads: `${oldData.totalLeads} ‚Üí ${newData.totalLeads}`,
                totalVendas: `${oldData.totalVendas} ‚Üí ${newData.totalVendas}`
            });
            
            render();
        }

        function getActiveFilters() {
            return Object.entries(state.filters).filter(([key, value]) => value && value.trim() !== '');
        }

        function loadCSVData() {
            try {
                console.log('=== CARREGANDO DADOS ===');
                
                // Primeiro, tentar carregar dados salvos localmente
                const savedData = loadSavedData();
                if (savedData) {
                    console.log('Dados carregados do armazenamento local:', {
                        leads: savedData.leads?.length || 0,
                        visitas: savedData.visitas?.length || 0,
                        pastas: savedData.pastas?.length || 0,
                        vendas: savedData.vendas?.length || 0
                    });
                    
                    state.leads = savedData.leads || [];
                    state.visitas = savedData.visitas || [];
                    state.pastas = savedData.pastas || [];
                    state.vendas = savedData.vendas || [];
                    state.loading = false;
                    render();
                    return;
                }
                
                // Se n√£o h√° dados salvos, usar dados de exemplo baseados na estrutura real
                console.log('Usando dados de exemplo baseados na estrutura real dos CSVs');
                
                state.leads = [
                    { Data: '27/11/2018', Empreendimento: 'Alta Vista Passare', 'Imobili ria': '', Corretor: '', 'Tipo de M dia': 'OFF', 'Origem M dia': 'Painel Gestor', QUALIFICADO: 'N√£o Qualificado', 'Tipo da visita': '', 'Situa  o da visita': '', LEADS: '1' },
                    { Data: '27/04/2021', Empreendimento: 'Conquista Eusebio', 'Imobili ria': '', Corretor: '', 'Tipo de M dia': 'ON', 'Origem M dia': 'Facebook', QUALIFICADO: 'Qualificado', 'Tipo da visita': '', 'Situa  o da visita': '', LEADS: '2' },
                    { Data: '15/05/2021', Empreendimento: 'Alta Vista Passare', 'Imobili ria': '', Corretor: '', 'Tipo de M dia': 'ON', 'Origem M dia': 'Google', QUALIFICADO: 'Qualificado', 'Tipo da visita': '', 'Situa  o da visita': '', LEADS: '1' },
                    { Data: '20/06/2021', Empreendimento: 'Conquista Eusebio', 'Imobili ria': '', Corretor: '', 'Tipo de M dia': 'ON', 'Origem M dia': 'Instagram', QUALIFICADO: 'N√£o Qualificado', 'Tipo da visita': '', 'Situa  o da visita': '', LEADS: '3' }
                ];
                
                state.visitas = [
                    { Data: '14/02/2014', Empreendimento: '', 'Imobili ria': '', Corretor: '', 'Tipo de M dia': 'ON', 'Origem M dia': 'ChatBot', 'Tipo da visita': 'Visita Espont nea', 'Situa  o da visita': 'Cancelado', QUALIFICADO: 'Qualificado', VISITA: '1' },
                    { Data: '15/10/2020', Empreendimento: '', 'Imobili ria': '', Corretor: '', 'Tipo de M dia': 'OFF', 'Origem M dia': 'Painel Imobili ria', 'Tipo da visita': 'Visita Agendada', 'Situa  o da visita': 'Conclu do', QUALIFICADO: 'N√£o Qualificado', VISITA: '2' },
                    { Data: '16/10/2020', Empreendimento: '', 'Imobili ria': '', Corretor: '', 'Tipo de M dia': 'ON', 'Origem M dia': 'Facebook', 'Tipo da visita': 'Visita Agendada', 'Situa  o da visita': 'Conclu do', QUALIFICADO: 'Qualificado', VISITA: '1' }
                ];
                
                state.pastas = [
                    { Data: '18/05/2021', Empreendimento: 'Alta Vista Passare', 'Imobili ria': 'CANAL IMOB', Corretor: 'METRIX IMOVEIS', 'Tipo de M dia': 'OFF', 'Origem M dia': 'Painel Gestor', ' Valor Presta  o ': '1567,37', 'Pasta analisada': 'Sim', 'Tipo da visita': '', 'Situa  o da visita': '', QUALIFICADO: 'N√£o Qualificado', PASTA: '1' },
                    { Data: '19/05/2021', Empreendimento: 'Alta Vista Passare', 'Imobili ria': 'CANAL IMOB', Corretor: 'METRIX IMOVEIS', 'Tipo de M dia': 'OFF', 'Origem M dia': 'Painel Pdv', ' Valor Presta  o ': '', 'Pasta analisada': '', 'Tipo da visita': '', 'Situa  o da visita': '', QUALIFICADO: 'N√£o Qualificado', PASTA: '2' },
                    { Data: '20/05/2021', Empreendimento: 'Conquista Eusebio', 'Imobili ria': '4F CE', Corretor: 'Jo√£o Silva', 'Tipo de M dia': 'ON', 'Origem M dia': 'Facebook', ' Valor Presta  o ': '2100,50', 'Pasta analisada': 'Sim', 'Tipo da visita': '', 'Situa  o da visita': '', QUALIFICADO: 'Qualificado', PASTA: '1' }
                ];
                
                state.vendas = [
                    { Data: '11/06/2021', Empreendimento: 'Alta Vista Passare', 'Imobili ria': '4F CE', Corretor: 'Thiago Viana', 'Tipo de M dia': 'OFF', 'Origem M dia': 'Painel Gestor', QUALIFICADO: 'N√£o Qualificado', 'Tipo da visita': '', 'Situa  o da visita': '', VENDA: '3' },
                    { Data: '12/06/2021', Empreendimento: 'Conquista Laguna', 'Imobili ria': '4F CE', Corretor: 'Maria Silva', 'Tipo de M dia': 'ON', 'Origem M dia': 'Google', QUALIFICADO: 'Qualificado', 'Tipo da visita': '', 'Situa  o da visita': '', VENDA: '1' }
                ];

                state.loading = false;
                
                console.log('Dados de exemplo carregados:', {
                    leads: state.leads.length,
                    visitas: state.visitas.length,
                    pastas: state.pastas.length,
                    vendas: state.vendas.length
                });
                
                render();
                
                // Log das visitas conclu√≠das dispon√≠veis ap√≥s carregar dados
                setTimeout(() => {
                    try {
                        const totalVisitasConcluidas = calculateFunilDataWithoutFilters().visitasConcluidas;
                        console.log(`üéØ VISITAS CONCLU√çDAS DISPON√çVEIS: ${totalVisitasConcluidas} no total. Aplicar filtros para segmentar!`);
                    } catch (error) {
                        console.log('Erro ao calcular visitas conclu√≠das iniciais:', error);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                state.loading = false;
                document.getElementById('app').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column;">
                        <div style="color: #dc2626; font-size: 18px; font-weight: bold; margin-bottom: 16px;">
                            Erro ao inicializar o dashboard
                        </div>
                        <div style="color: #6b7280; margin-bottom: 24px;">
                            ${error.message}
                        </div>
                        <button onclick="window.location.reload()" style="background: #1a5f4a; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                            Recarregar P√°gina
                        </button>
                    </div>
                `;
            }
        }

        // Fun√ß√µes para salvar/carregar dados localmente - IGUAIS AO ORIGINAL
        function saveDataLocally() {
            try {
                const dataToSave = {
                    leads: state.leads,
                    visitas: state.visitas,
                    pastas: state.pastas,
                    vendas: state.vendas,
                    savedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataString = JSON.stringify(dataToSave);
                const sizeInMB = (new Blob([dataString]).size / 1024 / 1024).toFixed(2);
                
                console.log(`Salvando ${sizeInMB}MB de dados localmente...`);
                
                localStorage.setItem('dashboard_vendas_data', dataString);
                localStorage.setItem('dashboard_vendas_backup', dataString);
                localStorage.setItem('dashboard_vendas_timestamp', new Date().getTime().toString());
                
                const testLoad = localStorage.getItem('dashboard_vendas_data');
                if (!testLoad) {
                    throw new Error('Falha ao verificar dados salvos');
                }
                
                updateSaveStatus(`‚úÖ Dados salvos com sucesso! (${sizeInMB}MB) - Recarregue a p√°gina para testar`);
                
                const saveBtn = document.getElementById('save-data-btn');
                if (saveBtn) {
                    saveBtn.innerHTML = '‚úÖ Dados Salvos!';
                    saveBtn.style.background = '#059669';
                    saveBtn.disabled = true;
                }
                
                setTimeout(() => {
                    updateSaveStatus(`üíæ Dados salvos! Agora voc√™ pode fechar e reabrir o dashboard que os dados carregam automaticamente.`);
                }, 2000);
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                updateSaveStatus(`‚ö†Ô∏è Erro ao salvar: ${error.message}. Verifique se o navegador permite localStorage.`);
                return false;
            }
        }

        function loadSavedData() {
            try {
                let savedString = localStorage.getItem('dashboard_vendas_data');
                
                if (!savedString) {
                    savedString = localStorage.getItem('dashboard_vendas_backup');
                }
                
                if (!savedString) {
                    console.log('Nenhum dado salvo encontrado');
                    return null;
                }
                
                const savedData = JSON.parse(savedString);
                
                if (!savedData.leads || !savedData.visitas || !savedData.pastas || !savedData.vendas) {
                    console.warn('Dados salvos incompletos, usando dados de exemplo');
                    return null;
                }
                
                console.log('‚úÖ Dados salvos carregados com sucesso:', {
                    savedAt: savedData.savedAt,
                    version: savedData.version,
                    leads: savedData.leads?.length || 0,
                    visitas: savedData.visitas?.length || 0,
                    pastas: savedData.pastas?.length || 0,
                    vendas: savedData.vendas?.length || 0
                });
                
                return savedData;
            } catch (error) {
                console.error('Erro ao carregar dados salvos:', error);
                
                try {
                    localStorage.removeItem('dashboard_vendas_data');
                    localStorage.removeItem('dashboard_vendas_backup');
                } catch (clearError) {
                    console.error('Erro ao limpar dados corrompidos:', clearError);
                }
                
                return null;
            }
        }

        function clearSavedData() {
            try {
                localStorage.removeItem('dashboard_vendas_data');
                localStorage.removeItem('dashboard_vendas_backup');
                localStorage.removeItem('dashboard_vendas_timestamp');
                localStorage.removeItem('dashboard_vendas_simple');
                
                updateSaveStatus('üóëÔ∏è Todos os dados locais foram removidos');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                console.error('Erro ao limpar dados:', error);
                updateSaveStatus(`‚ö†Ô∏è Erro ao limpar: ${error.message}`);
            }
        }

        function updateSaveStatus(message) {
            const statusDiv = document.getElementById('save-status');
            if (statusDiv) {
                statusDiv.innerHTML = `<div style="padding: 12px; border-radius: 8px; background: #f0fdf4; border: 1px solid #66ffaa; color: #0a4d3a; font-size: 13px; text-align: center; line-height: 1.4;">${message}</div>`;
            }
        }

        function checkSavedDataSize() {
            try {
                const savedString = localStorage.getItem('dashboard_vendas_data') || localStorage.getItem('dashboard_vendas_backup');
                if (savedString) {
                    const sizeInMB = (new Blob([savedString]).size / 1024 / 1024).toFixed(2);
                    const savedData = JSON.parse(savedString);
                    const savedDate = new Date(savedData.savedAt).toLocaleString('pt-BR');
                    return { 
                        size: sizeInMB, 
                        date: savedDate, 
                        exists: true,
                        recordCount: {
                            leads: savedData.leads?.length || 0,
                            visitas: savedData.visitas?.length || 0,
                            pastas: savedData.pastas?.length || 0,
                            vendas: savedData.vendas?.length || 0
                        }
                    };
                }
                return { exists: false };
            } catch {
                return { exists: false };
            }
        }

        // Fun√ß√£o para upload de arquivos - IGUAL AO ORIGINAL
        function createFileUploadInterface() {
            try {
                if (document.getElementById('file-upload-section')) {
                    console.log('Interface de upload j√° existe');
                    return;
                }

                const container = document.querySelector('.container');
                if (!container) {
                    console.warn('Container n√£o encontrado, tentando novamente...');
                    setTimeout(createFileUploadInterface, 500);
                    return;
                }

                const header = container.querySelector('.header');
                if (!header) {
                    console.warn('Header n√£o encontrado, criando interface mais tarde...');
                    return;
                }

                const savedInfo = checkSavedDataSize();

                const uploadSection = document.createElement('div');
                uploadSection.id = 'file-upload-section';
                uploadSection.innerHTML = `
                    <div class="card" style="margin-bottom: 40px; border: 2px solid #66ffaa;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 16px;">
                            <h3 style="color: #0a4d3a; font-size: 20px; font-weight: bold; margin: 0;">üìä Gerenciar Dados CSV</h3>
                            ${savedInfo.exists ? `
                                <div style="background: #f0fdf4; padding: 8px 16px; border-radius: 8px; border: 1px solid #66ffaa; font-size: 12px; color: #0a4d3a;">
                                    üíæ Dados salvos: ${savedInfo.size}MB (${savedInfo.date})
                                </div>
                            ` : ''}
                        </div>
                        
                        ${savedInfo.exists ? `
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 12px; border: 1px solid #3b82f6; margin-bottom: 20px;">
                                <div style="display: flex; justify-content: center; gap: 12px; align-items: center;">
                                    <span style="color: #1e40af; font-weight: 500;">‚úÖ Voc√™ j√° tem dados salvos localmente!</span>
                                    <button onclick="clearSavedData()" 
                                        style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                        üóëÔ∏è Limpar e Recarregar
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        
                        <p style="margin-bottom: 20px; color: #6b7280; font-size: 14px; line-height: 1.5;">
                            ${savedInfo.exists ? 'Para atualizar com novos dados, selecione os arquivos abaixo:' : 'Para usar seus dados reais, selecione os 4 arquivos CSV:'}
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
                            <div style="background: #f0fdf4; padding: 16px; border-radius: 12px; border: 1px solid #66ffaa;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0a4d3a; font-size: 14px;">üìÑ LEADS.csv</label>
                                <input type="file" id="leads-file" accept=".csv" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white;">
                                <div id="leads-status" style="margin-top: 4px; font-size: 12px; color: #6b7280;"></div>
                            </div>
                            
                            <div style="background: #f0fdf4; padding: 16px; border-radius: 12px; border: 1px solid #66ffaa;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0a4d3a; font-size: 14px;">üë• VISITA.csv</label>
                                <input type="file" id="visita-file" accept=".csv" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white;">
                                <div id="visita-status" style="margin-top: 4px; font-size: 12px; color: #6b7280;"></div>
                            </div>
                            
                            <div style="background: #f0fdf4; padding: 16px; border-radius: 12px; border: 1px solid #66ffaa;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0a4d3a; font-size: 14px;">üìÅ PASTA.csv</label>
                                <input type="file" id="pasta-file" accept=".csv" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white;">
                                <div id="pasta-status" style="margin-top: 4px; font-size: 12px; color: #6b7280;"></div>
                            </div>
                            
                            <div style="background: #f0fdf4; padding: 16px; border-radius: 12px; border: 1px solid #66ffaa;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0a4d3a; font-size: 14px;">üí∞ VENDAS.csv</label>
                                <input type="file" id="vendas-file" accept=".csv" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white;">
                                <div id="vendas-status" style="margin-top: 4px; font-size: 12px; color: #6b7280;"></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 16px;">
                            <button id="load-files-btn" onclick="loadFilesFromUpload()" 
                                style="background: linear-gradient(to right, #1a5f4a, #0a4d3a); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 16px; margin-right: 12px;">
                                üöÄ Carregar Dados dos Arquivos
                            </button>
                            
                            <button id="save-data-btn" onclick="saveDataLocally()" 
                                style="background: linear-gradient(to right, #059669, #047857); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 16px; display: none;">
                                üíæ Salvar Dados Localmente
                            </button>
                        </div>
                        
                        <div id="upload-status" style="margin-bottom: 12px; font-size: 14px; text-align: center;"></div>
                        <div id="save-status" style="font-size: 14px; text-align: center;"></div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px;">
                            <p style="margin: 0; color: #92400e; font-size: 13px; line-height: 1.4;">
                                <strong>üí° Como funciona o salvamento:</strong> Ap√≥s carregar seus CSVs, clique em "Salvar Dados Localmente". 
                                Os dados ficam armazenados no seu navegador e carregam automaticamente na pr√≥xima visita. 
                                ${savedInfo.exists ? 'Voc√™ pode limpar os dados salvos e recome√ßar a qualquer momento.' : 'Funciona offline e √© totalmente privado!'}
                            </p>
                        </div>
                    </div>
                `;
                
                header.parentNode.insertBefore(uploadSection, header.nextSibling);
                console.log('Interface de upload criada com sucesso');

            } catch (error) {
                console.error('Erro ao criar interface de upload:', error);
            }
        }

        function loadFilesFromUpload() {
            const files = {
                leads: document.getElementById('leads-file').files[0],
                visita: document.getElementById('visita-file').files[0],
                pasta: document.getElementById('pasta-file').files[0],
                vendas: document.getElementById('vendas-file').files[0]
            };

            const status = document.getElementById('upload-status');
            const loadBtn = document.getElementById('load-files-btn');
            let loadedCount = 0;
            const totalFiles = Object.values(files).filter(file => file).length;

            if (totalFiles === 0) {
                status.innerHTML = '<div style="color: #dc2626; background: #fef2f2; padding: 12px; border-radius: 8px; border: 1px solid #fecaca;">‚ö†Ô∏è Por favor, selecione pelo menos um arquivo CSV.</div>';
                return;
            }

            loadBtn.disabled = true;
            loadBtn.innerHTML = '‚è≥ Carregando...';
            loadBtn.style.background = '#9ca3af';
            
            status.innerHTML = `<div style="color: #1a5f4a; background: #f0fdf4; padding: 12px; border-radius: 8px; border: 1px solid #66ffaa;">
                üìä Processando ${totalFiles} arquivo(s)... Por favor aguarde.
            </div>`;

            state.leads = [];
            state.visitas = [];
            state.pastas = [];
            state.vendas = [];

            Object.entries(files).forEach(([key, file]) => {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const csvData = e.target.result;
                            const parsed = Papa.parse(csvData, {
                                header: true,
                                skipEmptyLines: true,
                                delimitersToGuess: [';', ',', '\t'],
                                dynamicTyping: false
                            });

                            if (parsed.errors.length > 0) {
                                console.warn(`Avisos ao processar ${file.name}:`, parsed.errors);
                            }

                            const stateKey = key === 'visita' ? 'visitas' : key === 'pasta' ? 'pastas' : key;
                            state[stateKey] = parsed.data;
                            
                            console.log(`${file.name} carregado:`, parsed.data.length, 'linhas');
                            
                            loadedCount++;
                            
                            status.innerHTML = `<div style="color: #1a5f4a; background: #f0fdf4; padding: 12px; border-radius: 8px; border: 1px solid #66ffaa;">
                                üìä Processando... ${loadedCount}/${totalFiles} arquivo(s) carregados
                            </div>`;
                            
                            if (loadedCount === totalFiles) {
                                state.loading = false;
                                
                                const stats = {
                                    leads: state.leads.length,
                                    visitas: state.visitas.length,
                                    pastas: state.pastas.length,
                                    vendas: state.vendas.length
                                };
                                
                                status.innerHTML = `<div style="color: #0a4d3a; background: #f0fdf4; padding: 16px; border-radius: 8px; border: 2px solid #66ffaa;">
                                    <div style="text-align: center; margin-bottom: 8px;">
                                        <strong style="font-size: 16px;">üéâ Dados Carregados com Sucesso!</strong>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 13px;">
                                        <div><strong>Leads:</strong> ${stats.leads}</div>
                                        <div><strong>Visitas:</strong> ${stats.visitas}</div>
                                        <div><strong>Pastas:</strong> ${stats.pastas}</div>
                                        <div><strong>Vendas:</strong> ${stats.vendas}</div>
                                    </div>
                                </div>`;
                                
                                loadBtn.disabled = false;
                                loadBtn.innerHTML = '‚úÖ Dados Carregados - Recarregar?';
                                loadBtn.style.background = 'linear-gradient(to right, #059669, #047857)';
                                
                                const saveBtn = document.getElementById('save-data-btn');
                                if (saveBtn) {
                                    saveBtn.style.display = 'inline-block';
                                    saveBtn.style.animation = 'pulse 2s infinite';
                                }
                                
                                render();
                                
                                setTimeout(() => {
                                    document.querySelector('.funnel-title').scrollIntoView({ 
                                        behavior: 'smooth',
                                        block: 'start'
                                    });
                                }, 500);
                                
                                setTimeout(() => {
                                    updateSaveStatus('üí° Agora clique em "Salvar Dados Localmente" para n√£o precisar carregar novamente!');
                                }, 2000);
                                
                                // Log inicial das visitas conclu√≠das para refer√™ncia
                                setTimeout(() => {
                                    const totalVisitasConcluidas = calculateFunilDataWithoutFilters().visitasConcluidas;
                                    console.log(`üéØ RESUMO INICIAL: ${totalVisitasConcluidas} visitas conclu√≠das dispon√≠veis nos dados. Use os filtros para segmentar os resultados em tempo real!`);
                                }, 3000);
                            }
                        } catch (error) {
                            console.error(`Erro ao processar ${file.name}:`, error);
                            status.innerHTML = `<div style="color: #dc2626; background: #fef2f2; padding: 12px; border-radius: 8px; border: 1px solid #fecaca;">
                                ‚ö†Ô∏è Erro ao processar ${file.name}: ${error.message}
                            </div>`;
                            
                            loadBtn.disabled = false;
                            loadBtn.innerHTML = 'üöÄ Carregar Dados dos Arquivos';
                            loadBtn.style.background = 'linear-gradient(to right, #1a5f4a, #0a4d3a)';
                        }
                    };
                    
                    reader.onerror = function() {
                        console.error(`Erro ao ler arquivo ${file.name}`);
                        status.innerHTML = `<div style="color: #dc2626; background: #fef2f2; padding: 12px; border-radius: 8px; border: 1px solid #fecaca;">
                            ‚ö†Ô∏è Erro ao ler arquivo ${file.name}
                        </div>`;
                    };
                    
                    // Ler o arquivo - navegadores modernos convertem automaticamente
                    reader.readAsText(file, 'UTF-8');
                }
            });
        }

        function render() {
            try {
                console.log('Iniciando render...', {
                    loading: state.loading,
                    leads: state.leads.length,
                    visitas: state.visitas.length,
                    pastas: state.pastas.length,
                    vendas: state.vendas.length
                });

                if (state.loading) {
                    console.log('Ainda carregando, mantendo tela de loading');
                    return;
                }

                const funilData = calculateFunilData();
                const filterOptions = getFilterOptions();
                const activeFilters = getActiveFilters();

                console.log('Dados do funil calculados:', funilData);

                const funilItems = [
                    { label: 'Leads', value: funilData.totalLeads, icon: 'users' },
                    { label: 'Oportunidades', value: funilData.oportunidades, icon: 'target' },
                    { label: 'Agendamentos', value: funilData.agendamentos, icon: 'calendar' },
                    { label: 'Visitas Conclu√≠das', value: funilData.visitasConcluidas, icon: 'eye' },
                    { label: 'Pasta Total', value: funilData.totalPastas, icon: 'folder' },
                    { label: 'Pasta Analisada', value: funilData.pastasAnalisadas, icon: 'trending-down' },
                    { label: 'Vendas', value: funilData.totalVendas, icon: 'dollar-sign' }
                ];

                const conversions = [
                    { from: 'Lead', to: 'Oportunidade', rate: funilData.totalLeads > 0 ? ((funilData.oportunidades / funilData.totalLeads) * 100).toFixed(1) : 0 },
                    { from: 'Oportunidade', to: 'Agendamento', rate: funilData.oportunidades > 0 ? ((funilData.agendamentos / funilData.oportunidades) * 100).toFixed(1) : 0 },
                    { from: 'Agendamento', to: 'Visita', rate: funilData.agendamentos > 0 ? ((funilData.visitasConcluidas / funilData.agendamentos) * 100).toFixed(1) : 0 },
                    { from: 'Visita', to: 'Pasta Total', rate: funilData.visitasConcluidas > 0 ? ((funilData.totalPastas / funilData.visitasConcluidas) * 100).toFixed(1) : 0 },
                    { from: 'Pasta Total', to: 'Analisada', rate: funilData.totalPastas > 0 ? ((funilData.pastasAnalisadas / funilData.totalPastas) * 100).toFixed(1) : 0 },
                    { from: 'Pasta Analisada', to: 'Venda', rate: funilData.pastasAnalisadas > 0 ? ((funilData.totalVendas / funilData.pastasAnalisadas) * 100).toFixed(1) : 0 }
                ];

                const app = document.getElementById('app');
                
                if (!app) {
                    console.error('Elemento #app n√£o encontrado!');
                    return;
                }

                console.log('Atualizando HTML do dashboard...');

                app.innerHTML = `
                    <div class="container">
                        <!-- Header -->
                        <div class="header">
                            <h1 class="title">Dashboard de Funil de Vendas</h1>
                            <p class="subtitle">An√°lise consolidada de performance comercial</p>
                            <div class="divider"></div>
                        </div>

                        <!-- Debug Info -->
                        ${state.showDebug ? `
                        <div class="debug-card">
                            <button class="close-btn" onclick="state.showDebug = false; render();">‚úï</button>
                            <h3 class="debug-title">Status do Sistema</h3>
                            <div class="debug-grid">
                                <div class="debug-item">
                                    <div class="debug-label">Leads</div>
                                    <div class="debug-value">${state.leads.length}</div>
                                    <div class="debug-label">Soma: ${funilData.totalLeads}</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Oportunidades</div>
                                    <div class="debug-value">${funilData.oportunidades}</div>
                                    <div class="debug-label">Soma qualif.</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Visitas Total</div>
                                    <div class="debug-value">${state.visitas.length}</div>
                                    <div class="debug-label">registros</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Filtradas</div>
                                    <div class="debug-value">${(() => {
                                        try {
                                            const filteredVisitas = applyFilters(state.visitas, 'Data');
                                            return filteredVisitas.length;
                                        } catch {
                                            return 0;
                                        }
                                    })()}</div>
                                    <div class="debug-label">ap√≥s filtros</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Conclu√≠das</div>
                                    <div class="debug-value">${funilData.visitasConcluidas}</div>
                                    <div class="debug-label">‚úÖ filtradas</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Taxa Conclus√£o</div>
                                    <div class="debug-value">${(() => {
                                        try {
                                            const filteredVisitas = applyFilters(state.visitas, 'Data');
                                            return filteredVisitas.length > 0 ? ((funilData.visitasConcluidas / filteredVisitas.length) * 100).toFixed(1) + '%' : '0%';
                                        } catch {
                                            return '0%';
                                        }
                                    })()}</div>
                                    <div class="debug-label">atual</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Agendamentos</div>
                                    <div class="debug-value">${funilData.agendamentos}</div>
                                    <div class="debug-label">Soma agend.</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Pastas</div>
                                    <div class="debug-value">${state.pastas.length}</div>
                                    <div class="debug-label">Soma: ${funilData.totalPastas}</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Analisadas</div>
                                    <div class="debug-value">${funilData.pastasAnalisadas}</div>
                                    <div class="debug-label">Soma c/ valor</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Vendas</div>
                                    <div class="debug-value">${state.vendas.length}</div>
                                    <div class="debug-label">Soma: ${funilData.totalVendas}</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Filtros Ativos</div>
                                    <div class="debug-value">${activeFilters.length}</div>
                                    <div class="debug-label">de 10 dispon√≠veis</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Origem M√≠dia</div>
                                    <div class="debug-value">${filterOptions.origemMidia.length}</div>
                                    <div class="debug-label">op√ß√µes</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Situa√ß√£o Filtro</div>
                                    <div class="debug-value">${state.filters.situacaoVisita || 'Todas'}</div>
                                    <div class="debug-label">selecionada</div>
                                </div>
                                <div class="debug-item">
                                    <div class="debug-label">Impacto Real</div>
                                    <div class="debug-value">${(() => {
                                        try {
                                            if (Object.entries(state.filters).filter(([k, v]) => v).length === 0) {
                                                return 'Sem filtros';
                                            }
                                            const semFiltros = calculateFunilDataWithoutFilters().visitasConcluidas;
                                            const comFiltros = funilData.visitasConcluidas;
                                            const diferenca = comFiltros - semFiltros;
                                            return diferenca === 0 ? 'Igual' : (diferenca > 0 ? `+${diferenca}` : `${diferenca}`);
                                        } catch {
                                            return 'N/A';
                                        }
                                    })()}</div>
                                    <div class="debug-label">vs sem filtros</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Filtros -->
                        <div class="card">
                            <div class="filters-header">
                                <div class="filters-title-group">
                                    <div class="icon-container">
                                        <svg class="icon" viewBox="0 0 24 24"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/></svg>
                                    </div>
                                    <h2 class="filters-title">Filtros</h2>
                                </div>
                                <button class="clear-btn" onclick="clearFilters()">Limpar Filtros</button>
                            </div>
                            
                            <div class="filters-grid">
                                <div class="filter-group">
                                    <label class="filter-label">Empreendimento</label>
                                    <select class="filter-select ${state.filters.empreendimento ? 'filter-active' : ''}" onchange="updateFilter('empreendimento', this.value);">
                                        <option value="">Todos</option>
                                        ${filterOptions.empreendimentos.map(emp => `<option value="${emp}" ${state.filters.empreendimento === emp ? 'selected' : ''}>${emp}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">üéØ Origem M√≠dia</label>
                                    <select class="filter-select ${state.filters.origemMidia ? 'filter-active' : ''}" onchange="updateFilter('origemMidia', this.value);">
                                        <option value="">Todas</option>
                                        ${filterOptions.origemMidia.map(origem => `<option value="${origem}" ${state.filters.origemMidia === origem ? 'selected' : ''}>${origem}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">üéØ Tipo de M√≠dia</label>
                                    <select class="filter-select ${state.filters.tipoMidia ? 'filter-active' : ''}" onchange="updateFilter('tipoMidia', this.value);">
                                        <option value="">Todos</option>
                                        ${filterOptions.tiposMidia.map(tipo => `<option value="${tipo}" ${state.filters.tipoMidia === tipo ? 'selected' : ''}>${tipo}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">üéØ Tipo de Visita</label>
                                    <select class="filter-select ${state.filters.tipoVisita ? 'filter-active' : ''}" onchange="updateFilter('tipoVisita', this.value);">
                                        <option value="">Todos</option>
                                        ${filterOptions.tiposVisita.map(tipo => `<option value="${tipo}" ${state.filters.tipoVisita === tipo ? 'selected' : ''}>${tipo}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">Qualifica√ß√£o</label>
                                    <select class="filter-select ${state.filters.qualificacao ? 'filter-active' : ''}" onchange="updateFilter('qualificacao', this.value);">
                                        <option value="">Todos</option>
                                        ${filterOptions.qualificacoes.map(qual => `<option value="${qual}" ${state.filters.qualificacao === qual ? 'selected' : ''}>${qual}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">Data In√≠cio</label>
                                    <input type="date" class="filter-input ${state.filters.dataInicio ? 'filter-active' : ''}" value="${state.filters.dataInicio}" onchange="updateFilter('dataInicio', this.value);">
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">Data Fim</label>
                                    <input type="date" class="filter-input ${state.filters.dataFim ? 'filter-active' : ''}" value="${state.filters.dataFim}" onchange="updateFilter('dataFim', this.value);">
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">Imobili√°ria</label>
                                    <select class="filter-select ${state.filters.imobiliaria ? 'filter-active' : ''}" onchange="updateFilter('imobiliaria', this.value);">
                                        <option value="">Todas</option>
                                        ${filterOptions.imobiliarias.map(imob => `<option value="${imob}" ${state.filters.imobiliaria === imob ? 'selected' : ''}>${imob}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">Corretor</label>
                                    <select class="filter-select ${state.filters.corretor ? 'filter-active' : ''}" onchange="updateFilter('corretor', this.value);">
                                        <option value="">Todos</option>
                                        ${filterOptions.corretores.map(corretor => `<option value="${corretor}" ${state.filters.corretor === corretor ? 'selected' : ''}>${corretor}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">üéØ Situa√ß√£o da Visita</label>
                                    <select class="filter-select ${state.filters.situacaoVisita ? 'filter-active' : ''}" onchange="updateFilter('situacaoVisita', this.value);">
                                        <option value="">Todas</option>
                                        ${filterOptions.situacoesVisita.map(situacao => `<option value="${situacao}" ${state.filters.situacaoVisita === situacao ? 'selected' : ''}>${situacao}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            ${activeFilters.length > 0 ? `
                            <div class="filter-status">
                                üîç <strong>${activeFilters.length} filtro(s) ativo(s):</strong> 
                                ${activeFilters.map(([key, value]) => {
                                    const labels = {
                                        empreendimento: 'Empreendimento',
                                        origemMidia: 'Origem M√≠dia',
                                        tipoMidia: 'Tipo de M√≠dia',
                                        tipoVisita: 'Tipo de Visita',
                                        qualificacao: 'Qualifica√ß√£o',
                                        dataInicio: 'Data In√≠cio',
                                        dataFim: 'Data Fim',
                                        imobiliaria: 'Imobili√°ria',
                                        corretor: 'Corretor',
                                        situacaoVisita: 'Situa√ß√£o da Visita'
                                    };
                                    return `<span style="background: #e0f2fe; padding: 2px 6px; border-radius: 4px; margin: 0 4px; font-size: 12px;">${labels[key]}: ${value}</span>`;
                                }).join('')}
                            </div>
                            ` : ''}
                        </div>

                        <!-- Funil -->
                        <div class="card">
                            <h2 class="funnel-title">Funil de Vendas ${activeFilters.length > 0 ? `(${activeFilters.length} filtro(s) aplicado(s))` : ''}</h2>
                            
                            ${activeFilters.length > 0 ? `
                            <div style="text-align: center; margin-bottom: 20px; padding: 12px; background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px;">
                                <div style="color: #1e40af; font-weight: 500; margin-bottom: 4px;">üîç Dados filtrados em tempo real</div>
                                <div style="color: #1e40af; font-size: 13px;">
                                    Visitas conclu√≠das: <strong>${funilData.visitasConcluidas}</strong> de <strong>${(() => {
                                        try {
                                            return applyFilters(state.visitas, 'Data').length;
                                        } catch { return 0; }
                                    })()}</strong> visitas filtradas
                                    ${(() => {
                                        try {
                                            const filteredVisitas = applyFilters(state.visitas, 'Data');
                                            const taxa = filteredVisitas.length > 0 ? ((funilData.visitasConcluidas / filteredVisitas.length) * 100).toFixed(1) : 0;
                                            return `(${taxa}% de conclus√£o)`;
                                        } catch { return ''; }
                                    })()}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="funnel-container">
                                ${funilItems.map((item, index) => `
                                    <div class="funnel-item">
                                        <div class="funnel-step funnel-step-${index} ${index === 3 && activeFilters.length > 0 ? 'updated' : ''}">
                                            <div class="funnel-content">
                                                <div class="funnel-header-icon">
                                                    ${getIconSVG(item.icon)}
                                                    <span class="funnel-label">${item.label}${index === 3 && activeFilters.length > 0 ? ' üîç' : ''}</span>
                                                </div>
                                                <div class="funnel-value ${index === 3 && activeFilters.length > 0 ? 'value-changed' : ''}">${item.value.toLocaleString()}</div>
                                                ${index === 3 && activeFilters.length > 0 ? `
                                                    <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">
                                                        Filtrado em tempo real
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    ${index < funilItems.length - 1 ? '<div class="funnel-connector"></div>' : ''}
                                `).join('')}
                            </div>

                            <!-- Taxas de Convers√£o -->
                            <div class="conversion-section">
                                <h3 class="conversion-title">Taxas de Convers√£o ${activeFilters.length > 0 ? '(Filtradas)' : ''}</h3>
                                
                                ${activeFilters.length > 0 ? `
                                <div style="text-align: center; margin-bottom: 16px; padding: 10px; background: #f0f9ff; border-radius: 8px; border: 1px solid #3b82f6;">
                                    <div style="color: #1e40af; font-size: 13px; font-weight: 500;">
                                        üìä An√°lise com ${activeFilters.length} filtro(s) aplicado(s) | 
                                        Visitas conclu√≠das: <strong>${funilData.visitasConcluidas}</strong>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div class="conversion-grid">
                                    ${conversions.map(conversion => `
                                        <div class="conversion-card">
                                            <div class="conversion-label">${conversion.from} ‚Üí ${conversion.to}</div>
                                            <div class="conversion-rate">${conversion.rate}%</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                console.log('Dashboard renderizado com sucesso!');

                // Aplicar estilos adicionais aos filtros ativos ap√≥s render
                setTimeout(() => {
                    document.querySelectorAll('.filter-active').forEach(element => {
                        element.style.transition = 'all 0.3s ease';
                    });
                }, 100);

            } catch (error) {
                console.error('Erro no render:', error);
                
                const app = document.getElementById('app');
                if (app) {
                    app.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; padding: 20px;">
                            <div style="color: #dc2626; font-size: 20px; font-weight: bold; margin-bottom: 16px; text-align: center;">
                                Erro ao renderizar o dashboard
                            </div>
                            <div style="color: #6b7280; margin-bottom: 24px; text-align: center;">
                                ${error.message}
                            </div>
                            <button onclick="window.location.reload()" style="background: #1a5f4a; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                Recarregar P√°gina
                            </button>
                        </div>
                    `;
                }
            }
        }

        function getIconSVG(iconName) {
            const icons = {
                users: '<svg class="funnel-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
                target: '<svg class="funnel-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>',
                calendar: '<svg class="funnel-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
                eye: '<svg class="funnel-icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
                folder: '<svg class="funnel-icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>',
                'trending-down': '<svg class="funnel-icon" viewBox="0 0 24 24"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>',
                'dollar-sign': '<svg class="funnel-icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>'
            };
            return icons[iconName] || '';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('=== INICIANDO DASHBOARD CORRIGIDO ===');
                
                try {
                    const testKey = 'test_storage_' + Date.now();
                    const testData = JSON.stringify({test: 'data', array: [1,2,3,4,5]});
                    localStorage.setItem(testKey, testData);
                    const retrieved = localStorage.getItem(testKey);
                    localStorage.removeItem(testKey);
                    
                    if (retrieved === testData) {
                        console.log('‚úÖ localStorage funcionando corretamente');
                    } else {
                        console.warn('‚ö†Ô∏è localStorage com problemas de integridade');
                    }
                } catch (storageError) {
                    console.error('‚ö†Ô∏è localStorage n√£o dispon√≠vel:', storageError);
                }
                
                console.log('1. Carregando dados...');
                loadCSVData();
                
                console.log('2. Agendando cria√ß√£o da interface de upload...');
                setTimeout(() => {
                    try {
                        createFileUploadInterface();
                    } catch (uploadError) {
                        console.warn('Erro na interface de upload (n√£o cr√≠tico):', uploadError);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('ERRO CR√çTICO na inicializa√ß√£o:', error);
                
                document.getElementById('app').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; padding: 20px;">
                        <div style="text-align: center; max-width: 600px;">
                            <div style="color: #dc2626; font-size: 24px; font-weight: bold; margin-bottom: 16px;">
                                ‚ö†Ô∏è Erro ao carregar o dashboard
                            </div>
                            <div style="color: #6b7280; margin-bottom: 24px; line-height: 1.5;">
                                N√£o foi poss√≠vel inicializar o dashboard. Detalhes t√©cnicos:
                                <br><br>
                                <code style="background: #f3f4f6; padding: 8px; border-radius: 4px; font-size: 12px;">${error.message}</code>
                            </div>
                            <div style="display: flex; gap: 16px; justify-content: center;">
                                <button onclick="window.location.reload()" 
                                    style="background: #1a5f4a; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                    üîÑ Recarregar
                                </button>
                                <button onclick="console.log('Detalhes do erro:', arguments)" 
                                    style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                    üîç Console (F12)
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
